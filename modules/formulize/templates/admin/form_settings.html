<div class="panel-content content">


<{* form elements must be named with their object name hyphen field name *}>
<{* no other elements should have hyphens, since that tells the saving system that this is a property of an object to update *}>
<{* securitytoken should be part of the form *}>
<{* formulize_admin_handler and formulize_admin_key are required, to tell what the name of the save handling file is, and what the key is that we're inserting/updating on *}>

<form id="form-<{$number}>" class="formulize-admin-form">
<{php}>print $GLOBALS['xoopsSecurity']->getTokenHTML()<{/php}>
<input type="hidden" name="formulize_admin_handler" value="form_settings">
<input type="hidden" name="formulize_admin_key" value="<{$content.fid}>">
<input type="hidden" name="application_url_id" value="<{$content.aid}>">
<input type="hidden" id="reload_settings" name="reload_settings" value="<{if $content.fid == 'new'}>1<{/if}>">
<input type="hidden" class="entries-are-users-conditions-conditionsdelete" name="conditionsdelete" value="">
<input type="hidden" id="per_group_conditionsdelete" name="per_group_conditionsdelete" value="">


		<div class="form-item required">
        	<fieldset>
                <legend>Form Name and Labels</legend>
								<p><label for="forms-form_title" class="question"><{$smarty.const._AM_SETTINGS_FORM_TITLE}></label>
								<input type="text" id="forms-form_title" name="forms-form_title" class="required_formulize_element" value="<{$content.name}>" <{if $content.name == ""}>placeholder="<{$smarty.const._AM_APP_NEWFORM}>"<{/if}> onkeyup="fillHandle()" /> <a class="tooltip"><span><{$smarty.const._AM_SETTINGS_FORM_TITLE_EXPLAIN}></span></a></p>
								<div id="form-names-flex">
									<div class='spacer-line'></div>
									<p><label for="forms-singular" class="question"><{$smarty.const._AM_SETTINGS_FORM_SINGULAR}></label>
									<input type="text" id="forms-singular" name="forms-singular" value="<{$content.singular}>" <{if $content.name == ""}>placeholder="<{$smarty.const._AM_APP_NEWSINGULAR}>"<{/if}>/> <a class="tooltip"><span><{$smarty.const._AM_SETTINGS_FORM_SINGULAR_EXPLAIN}></span></a></p>
									<div class='spacer'></div>
									<p><label for="forms-plural" class="question"><{$smarty.const._AM_SETTINGS_FORM_PLURAL}></label>
									<input type="text" id="forms-plural" name="forms-plural" value="<{$content.plural}>" <{if $content.name == ""}>placeholder="<{$smarty.const._AM_APP_NEWPLURAL}>"<{/if}>/> <a class="tooltip"><span><{$smarty.const._AM_SETTINGS_FORM_PLURAL_EXPLAIN}></span></a></p>
									<div class='spacer'></div>
									<P><label for="forms-form_handle" class="question"><{$smarty.const._AM_SETTINGS_FORM_HANDLE}></label>
									<input type="text" name="forms-form_handle" value="<{$content.form_handle}>" > <a class="tooltip"><span><{$smarty.const._AM_SETTINGS_FORM_HANDLE_EXPLAIN}></span></a></P>
								</div>
            </fieldset>
		</div>

		<{if $content.istableform == false AND $content.fid != 'new'}>
			<{include file="db:admin/primary_identifier_selection.html" content=$content}>
		<{elseif $content.fid == 'new'}>
			<div class="form-item">
				<fieldset>
					<legend><label class="question"><{$smarty.const._AM_SETTINGS_FORM_PI_NEW}></label></legend>
					<label for="pi-new-no"><input type="radio" id="pi-new-no" name="pi_new_yes_no" value="no" checked /><{$smarty.const._AM_NO}></label>
					<br>
					<label for="pi-new-yes"><input type="radio" id="pi-new-yes" name="pi_new_yes_no" value="yes" /><{$smarty.const._AM_SETTINGS_FORM_PI_NEW_YES}><input type="text" name="pi_new_caption" value="<{$smarty.const._AM_ITEMNAME}>" /></label>
					<div class="description">
						<{$smarty.const._AM_SETTINGS_FORM_PI_DESC}>
					</div>
				</fieldset>
			</div>
		<{/if}>

		<{if $content.fid != 'new'}>
			<div class="form-item">
       	<fieldset>
					<legend><label class="question">Connections with other forms</label></legend>
					<{if $content.connections}>
					<{include file="db:admin/relationship_listing.html" sectionContent=$content.connections}>
					<{/if}>
					<p><a class='relationship-link-create-connection' target='<{$content.fid}>' href=""><img src="../images/filenew2.png"> Create a Connection</a></p>
				</fieldset>
			</div>
		<{/if}>

		<div class="form-item">
			<fieldset>
					<legend><label class="question"><{$smarty.const._AM_SETTINGS_FORM_APP_PART}></label></legend>
					<{if $content.applications|is_array AND $content.applications|@count > 0}>
					<select name="apps[]" id="apps" size=10 multiple>
							<{foreach from=$content.applications item=application}>
									<option value=<{$application.appid}><{$application.selected}>><{$application.text}></option>
							<{/foreach}>
					</select>
					<{/if}>
					<p><{$smarty.const._AM_SETTINGS_FORM_APPNEW}></p>
					<div class="form-radios radio-inline">
							<label for="new-app-yes"><input type="radio" id="new-app-yes" name="new_app_yes_no" value="yes" <{if $content.fid == 'new' AND $content.applications|@count == 0}>checked<{/if}> /><{$smarty.const._AM_YES}></label>
					</div>
					<div class="form-radios radio-inline">
							<label for="new-app-no"><input type="radio" id="new-app-no" name="new_app_yes_no" value="no" <{if $content.fid != 'new' OR $content.applications|@count > 0}>checked<{/if}> /><{$smarty.const._AM_NO}></label>
					</div>
					<div class="form-item" id="new-application-box" <{if $content.fid != 'new' OR $content.applications|@count > 0}>style="display: none;"<{/if}>>
					<label class="question">What is the name of the new application?</label>
					<input type="text" id="applications-name" name="applications-name" value="<{if $content.fid == 'new' AND $content.applications|@count == 0}>Forms and Data<{/if}>" />
			</fieldset>
		</div>

		<{if $content.istableform == true && $content.fid == "new"}>
			<div class="form-item">
				<fieldset>
                    <legend><label for="database_table" class="question"><{$smarty.const._AM_SETTINGS_FORM_DATABASE}></label></legend>
                    <input type="text" id="forms-tableform" name="forms-tableform" value="" />
                    <div class="description">
                        <p><{$smarty.const._AM_SETTINGS_FORM_DATABASE_EXPLAIN}></p>
                    </div>
                </fieldset>
			</div>
		<{/if}>

		<{if $content.istableform == false}>

			<div class="form-item">
        	<fieldset>
				<legend><label class="question"><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ALLOWED}></label></legend>

				<div class="form-radios">
					<label for="group"><input type="radio" id="group" name="forms-single" value="group" /><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ONEPERGROUP}></label>
				</div>
				<div class="form-radios">
					<label for="on"><input type="radio" id="user" name="forms-single" value="user" /><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ONEPERUSER}></label>
				</div>
				<div class="form-radios">
					<label for="empty"><input type="radio" id="off" name="forms-single" value="off" /><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_MORETHANONE}></label>
				</div>
             </fieldset>
		</div>

		<!-- Entries Represent Users -->
		<!-- TODO add option for entry_user_is_owner!! -->
		<div class="form-item" id="entries_are_users_container">
			<fieldset>
				<legend><label class="question"><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS}></label></legend>
				<div class="form-radios">
					<label for="entries_are_users-0">
						<input type="radio" id="entries_are_users-0" name="forms-entries_are_users" value="0" />
						<{$smarty.const._AM_NO}>
					</label>
				</div>
				<div class="form-radios">
					<label for="entries_are_users-1">
						<input type="radio" id="entries_are_users-1" name="forms-entries_are_users" value="1" />
						<{$smarty.const._AM_YES}>
					</label>
				</div>
				<div class="description">
					<p><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_EXPLAIN}></p>
				</div>

				<!-- Group Membership -->
				<{if $content.entries_are_users_default_groups_ui}>
				<div id="entries_are_users_default_groups_container" style="display: none; margin-top: 15px; padding: 15px; border: 1px solid #ddd; background: #f9f9f9;">
					<h4 style="margin-top: 0;"><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_TITLE}></h4>
					<p><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_DESC}></p>
					<{$content.entries_are_users_default_groups_ui}>
					<div id="default_groups_selected_list" style="margin-top: 10px;">
						<{if $content.entries_are_users_default_groups_selected|is_array}>

						<{* Render regular (non-template) groups as standalone items *}>
						<{foreach from=$content.entries_are_users_default_groups_selected item=group}>
						<{if !$group.isTemplate}>
						<div class="default-group-item" data-groupid="<{$group.id}>" style="margin-bottom: 5px; padding: 4px 8px; background: #e9e9e9; border-radius: 3px;">
							<span style="font-weight: bold;"><{$group.name}></span>
							<span>&mdash;</span>
							<a href="#" class="toggle-group-conditions-btn" data-groupid="<{$group.id}>" style="font-size: 0.85em; font-weight: normal;"><{if $group.hasConditions}><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_CONDITIONS_HIDE}><{else}><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_CONDITIONS_SHOW}><{/if}></a>
							<span>&mdash;</span>
							<a href="#" class="remove-default-group-btn" style="font-size: 0.85em; font-weight: normal;"><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_REMOVE}></a>
							<input type="hidden" name="entries_are_users_default_groups[]" value="<{$group.id}>" />
							<div class="per-group-conditions-panel" data-groupid="<{$group.id}>" style="display: <{if $group.hasConditions}>block<{else}>none<{/if}>; margin-top: 8px; padding: 10px; border: 1px solid #ccc; background: #f5f5f5; border-radius: 3px;">
								<p style="margin-top: 0; font-size: 0.85em; font-style: italic; color: #666;"><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_CONDITIONS_DESC}></p>
								<{if $content.per_group_conditions_ui[$group.id]}>
								<{$content.per_group_conditions_ui[$group.id]}>
								<{else}>
								<p style="font-size: 0.85em; color: #999;">No conditions set. Save the form to enable adding conditions for this group.</p>
								<{/if}>
							</div>
						</div>
						<{/if}>
						<{/foreach}>

						<{* Render template group clusters *}>
						<{if $content.template_group_clusters|is_array}>
						<{foreach from=$content.template_group_clusters key=eagFormId item=cluster}>
						<div class="template-group-cluster" data-eagformid="<{$eagFormId}>" style="margin-bottom: 5px; padding: 8px; background: #e9e9e9; border-radius: 3px;">
							<{foreach from=$content.entries_are_users_default_groups_selected item=group}>
							<{if $group.isTemplate && $group.eagFormId == $eagFormId}>
							<div class="default-group-item template-group-in-cluster" data-groupid="<{$group.id}>" style="margin-bottom: 4px;">
								<span style="font-weight: bold;"><{$group.name}></span>
								<span>&mdash;</span>
								<a href="#" class="toggle-group-conditions-btn" data-groupid="<{$group.id}>" style="font-size: 0.85em; font-weight: normal;"><{if $group.hasConditions}><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_CONDITIONS_HIDE}><{else}><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_CONDITIONS_SHOW}><{/if}></a>
								<span>&mdash;</span>
								<a href="#" class="remove-default-group-btn" style="font-size: 0.85em; font-weight: normal;"><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_REMOVE}></a>
								<input type="hidden" name="entries_are_users_default_groups[]" value="<{$group.id}>" />
								<input type="hidden" name="entries_are_users_default_groups_form_map[<{$group.id}>]" value="<{$eagFormId}>" />
								<div class="per-group-conditions-panel" data-groupid="<{$group.id}>" style="display: <{if $group.hasConditions}>block<{else}>none<{/if}>; margin-top: 8px; padding: 10px; border: 1px solid #ccc; background: #f5f5f5; border-radius: 3px;">
									<p style="margin-top: 0; font-size: 0.85em; font-style: italic; color: #666;"><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_CONDITIONS_DESC}></p>
									<{if $content.per_group_conditions_ui[$group.id]}>
									<{$content.per_group_conditions_ui[$group.id]}>
									<{else}>
									<p style="font-size: 0.85em; color: #999;">No conditions set. Save the form to enable adding conditions for this group.</p>
									<{/if}>
								</div>
							</div>
							<{/if}>
							<{/foreach}>
							<{if $cluster.description}>
							<div class="template-group-cluster-description" style="font-size: 0.85em; font-style: italic; color: #666; margin-top: 4px;"><{$cluster.description}></div>
							<{/if}>
							<{if $cluster.elementsByForm|is_array && $cluster.elementsByForm|@count}>
							<table class="template-group-cluster-checkboxes" style="margin-top: 4px; font-size: 0.9em; border: none; border-collapse: collapse;">
								<{foreach from=$cluster.elementsByForm item=formGroup}>
								<tr>
									<td style="vertical-align: top; padding: 4px 12px 4px 0; width: 200px; text-align: right; border: none;"><{$formGroup.formName}>:</td>
									<td style="vertical-align: top; padding: 4px 0; border: none;">
										<{foreach from=$formGroup.elements item=linkedEl}>
										<label style="display: block;">
											<input type="checkbox" name="entries_are_users_default_groups_element_links[<{$eagFormId}>][]"
												value="<{$linkedEl.ele_id}>"
												class="template-group-element-checkbox"
												<{if $linkedEl.selected}>checked="checked"<{/if}> />
											<{$linkedEl.caption}>
										</label>
										<{/foreach}>
									</td>
								</tr>
								<{/foreach}>
							</table>
							<{/if}>
						</div>
						<{/foreach}>
						<{/if}>

						<{/if}>
					</div>
				</div>
				<{/if}>

				<!-- User Creation Conditions -->
				<{if $content.entries_are_users_conditions_ui}>
				<div id="entries_are_users_conditions_container" style="display: none; margin-top: 15px; padding: 15px; border: 1px solid #ddd; background: #f9f9f9;">
					<h4 style="margin-top: 0;"><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_CONDITIONS_TITLE}></h4>
					<{$content.entries_are_users_conditions_ui}>
					<div class="description">
						<p><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_CONDITIONS_DESC}></p>
					</div>
				</div>
				<{/if}>

				<!-- User Mapping for Existing Entries -->
				<{if $content.show_user_mapping_ui AND $content.elementheadings|is_array AND $content.elementheadings|@count}>
				<div id="user_mapping_container" style="margin-top: 15px; padding: 15px; border: 1px solid #ddd; background: #f9f9f9;">
					<h4 style="margin-top: 0;"><{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_TITLE}></h4>
					<p><{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_QUESTION}></p>

					<div class="form-radios">
						<label for="user_mapping_yes_no-0">
							<input type="radio" id="user_mapping_yes_no-0" name="user_mapping_yes_no" value="0" checked />
							<{$smarty.const._AM_NO}>
						</label>
					</div>
					<div class="form-radios">
						<label for="user_mapping_yes_no-1">
							<input type="radio" id="user_mapping_yes_no-1" name="user_mapping_yes_no" value="1" />
							<{$smarty.const._AM_YES}>
						</label>
					</div>

					<div id="user_mapping_details" style="display: none; margin-top: 15px;">
						<p><{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_EXPLAIN}></p>

						<div style="display: flex; gap: 30px; margin-top: 10px;">
							<div style="display: flex; flex-direction: column;">
								<label style="font-weight: bold; margin-bottom: 5px;"><{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_ELEMENT_LABEL}></label>
								<select name="user_mapping_element" id="user_mapping_element" style="width: auto;">
									<option value=""><{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_ELEMENT_SELECT}></option>
									<{foreach from=$content.elementheadings item=element}>
									<option value="<{$element.ele_id}>"><{$element.text}></option>
									<{/foreach}>
								</select>
							</div>
							<div style="display: flex; flex-direction: column;">
								<label style="font-weight: bold; margin-bottom: 5px;"><{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_CONTAINS_LABEL}></label>
								<label for="user_mapping_type-login_name" style="margin-bottom: 3px;">
									<input type="radio" id="user_mapping_type-login_name" name="user_mapping_type" value="login_name" />
									<{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_TYPE_USERNAME}>
								</label>
								<label for="user_mapping_type-email" style="margin-bottom: 3px;">
									<input type="radio" id="user_mapping_type-email" name="user_mapping_type" value="email" />
									<{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_TYPE_EMAIL}>
								</label>
								<label for="user_mapping_type-uid">
									<input type="radio" id="user_mapping_type-uid" name="user_mapping_type" value="uid" />
									<{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_TYPE_UID}>
								</label>
							</div>
						</div>

						<p style="margin-top: 10px;"><em><{$smarty.const._AM_SETTINGS_FORM_USER_MAPPING_SYNC_NOTE}></em></p>
					</div>
				</div>
				<{/if}>
			</fieldset>
		</div>

		<!-- Entries Represent Groups -->
		<div class="form-item" id="entries_are_groups_container">
			<fieldset>
				<legend><label class="question"><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_GROUPS}></label></legend>
				<div class="form-radios">
					<label for="entries_are_groups-0">
						<input type="radio" id="entries_are_groups-0" name="forms-entries_are_groups" value="0" />
						<{$smarty.const._AM_NO}>
					</label>
				</div>
				<div class="form-radios">
					<label for="entries_are_groups-1">
						<input type="radio" id="entries_are_groups-1" name="forms-entries_are_groups" value="1" />
						<{$smarty.const._AM_YES}>
					</label>
				</div>
				<div class="description">
					<p><{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_GROUPS_EXPLAIN}></p>
				</div>

				<!-- Group Categories Configuration -->
				<div id="group_categories_container" style="display: none; margin-top: 15px; padding: 15px; border: 1px solid #ddd; background: #f9f9f9;">
					<h4 style="margin-top: 0;"><{$smarty.const._AM_SETTINGS_FORM_GROUP_CATEGORIES_TITLE}></h4>

					<!-- Base category - always present, not editable -->
					<div style="margin-top: 15px;">
						<div class="group-category-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
							<input type="text" value="<{$smarty.const._AM_SETTINGS_FORM_GROUP_CATEGORIES_ALL_USERS}>" style="flex: 1; max-width: 300px; background: #e9e9e9; color: #666;" disabled />
						</div>
					</div>

					<div id="group_categories_list">
						<!-- Additional categories will be listed here -->
						<!-- For existing categories, the key ($groupid) is the group ID in the database -->
						<!-- For new categories added via JS, the key will be "new_X" where X is a counter -->
						<{if $content.group_categories|is_array}>
						<{foreach from=$content.group_categories item=category key=groupid}>
						<div class="group-category-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
							<input type="text" name="group_categories[<{$groupid}>]" value="<{$category}>" style="flex: 1; max-width: 300px;" placeholder="<{$smarty.const._AM_SETTINGS_FORM_GROUP_CATEGORIES_PLACEHOLDER}>" />
							<button type="button" class="remove-category-btn" style="padding: 4px 8px; cursor: pointer;" title="<{$smarty.const._AM_SETTINGS_FORM_GROUP_CATEGORIES_REMOVE}>">&times;</button>
						</div>
						<{/foreach}>
						<{/if}>
					</div>

					<div style="margin-top: 15px;">
						<button type="button" id="add_group_category_btn" style="padding: 6px 12px; cursor: pointer;">
							<img src="../images/filenew2.png" style="vertical-align: middle; margin-right: 5px;" alt="" /><{$smarty.const._AM_SETTINGS_FORM_GROUP_CATEGORIES_ADD}>
						</button>
					</div>

					<p style="margin-top: 15px;"><em><{$smarty.const._AM_SETTINGS_FORM_GROUP_CATEGORIES_NOTE}></em></p>
				</div>
			</fieldset>
		</div>

		<script>
		// Initialize checked state
		$("#entries_are_users-<{$content.entries_are_users}>").attr('checked', 'checked');
		$("#entries_are_groups-<{$content.entries_are_groups}>").attr('checked', 'checked');

		// Initialize visibility based on current values
		if (parseInt("<{$content.entries_are_users}>") == 1) {
			$("#entries_are_groups_container").hide();
		}
		if (parseInt("<{$content.entries_are_groups}>") == 1) {
			$("#entries_are_users_container").hide();
			$("#group_categories_container").show();
		}

		// Initialize user mapping container visibility based on entries_are_users
		if (parseInt("<{$content.entries_are_users}>") != 1) {
			$("#user_mapping_container").hide();
			$("#entries_are_users_conditions_container").hide();
			$("#entries_are_users_default_groups_container").hide();
		} else {
			$("#entries_are_users_conditions_container").show();
			$("#entries_are_users_default_groups_container").show();
		}

		// Mutual exclusivity: if one is set to Yes, set the other to No and hide it
		$("input[name='forms-entries_are_users']").change(function() {
			if ($(this).val() == "1" && $(this).is(':checked')) {
				$("#entries_are_groups-0").attr('checked', 'checked');
				$("#entries_are_groups_container").slideUp();
				$("#group_categories_container").slideUp();
				$("#user_mapping_container").slideDown();
				$("#entries_are_users_conditions_container").slideDown();
				$("#entries_are_users_default_groups_container").slideDown();
			} else if ($(this).val() == "0" && $(this).is(':checked')) {
				$("#entries_are_groups_container").slideDown();
				$("#user_mapping_container").slideUp();
				$("#entries_are_users_conditions_container").slideUp();
				$("#entries_are_users_default_groups_container").slideUp();
			}
		});

		$("input[name='forms-entries_are_groups']").change(function() {
			if ($(this).val() == "1" && $(this).is(':checked')) {
				$("#entries_are_users-0").attr('checked', 'checked');
				$("#entries_are_users_container").slideUp();
				$("#user_mapping_container").slideUp();
				$("#entries_are_users_conditions_container").slideUp();
				$("#entries_are_users_default_groups_container").slideUp();
				$("#group_categories_container").slideDown();
			} else if ($(this).val() == "0" && $(this).is(':checked')) {
				$("#entries_are_users_container").slideDown();
				$("#group_categories_container").slideUp();
			}
		});

		// User mapping yes/no toggle
		$("input[name='user_mapping_yes_no']").change(function() {
			if ($(this).val() == "1" && $(this).is(':checked')) {
				$("#user_mapping_details").slideDown();
			} else if ($(this).val() == "0" && $(this).is(':checked')) {
				$("#user_mapping_details").slideUp();
			}
		});

		// Group categories management
		// Counter for new categories (keys will be "new_0", "new_1", etc.)
		var newCategoryCounter = 0;
		$("#add_group_category_btn").click(function() {
			var newKey = 'new_' + newCategoryCounter;
			newCategoryCounter++;
			var newCategoryHtml = '<div class="group-category-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">' +
				'<input type="text" name="group_categories[' + newKey + ']" value="" style="flex: 1; max-width: 300px;" placeholder="<{$smarty.const._AM_SETTINGS_FORM_GROUP_CATEGORIES_PLACEHOLDER}>" />' +
				'<button type="button" class="remove-category-btn" style="padding: 4px 8px; cursor: pointer;" title="<{$smarty.const._AM_SETTINGS_FORM_GROUP_CATEGORIES_REMOVE}>">&times;</button>' +
				'</div>';
			$("#group_categories_list").append(newCategoryHtml);
			// Focus on the new input
			$("#group_categories_list .group-category-item:last-child input").focus();
		});

		// Remove category button handler (using delegation for dynamically added elements)
		$(".remove-category-btn").live("click", function() {
			$(this).closest(".group-category-item").remove();
		});

		// Template group metadata for element checkboxes and descriptions
		var templateGroupMetadata = <{$content.template_group_metadata_json}>;

		var removeLabel = "<{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_REMOVE}>";
		var conditionsShowLabel = "<{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_CONDITIONS_SHOW}>";
		var conditionsHideLabel = "<{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_CONDITIONS_HIDE}>";

		// Helper: build group item HTML for a template group inside a cluster
		function buildTemplateGroupItemHtml(groupId, groupName, eagFormId) {
			return '<div class="default-group-item template-group-in-cluster" data-groupid="' + groupId + '" style="margin-bottom: 4px;">' +
				'<span style="font-weight: bold;">' + groupName + '</span>' +
				' <span>&mdash;</span> ' +
				'<a href="#" class="toggle-group-conditions-btn" data-groupid="' + groupId + '" style="font-size: 0.85em; font-weight: normal;">' + conditionsShowLabel + '</a>' +
				' <span>&mdash;</span> ' +
				'<a href="#" class="remove-default-group-btn" style="font-size: 0.85em; font-weight: normal;">' + removeLabel + '</a>' +
				'<input type="hidden" name="entries_are_users_default_groups[]" value="' + groupId + '" />' +
				'<input type="hidden" name="entries_are_users_default_groups_form_map[' + groupId + ']" value="' + eagFormId + '" />' +
				'<div class="per-group-conditions-panel" data-groupid="' + groupId + '" style="display: none; margin-top: 8px; padding: 10px; border: 1px solid #ccc; background: #f5f5f5; border-radius: 3px;">' +
				'<p style="font-size: 0.85em; color: #999;">No conditions set. Save the form to enable adding conditions for this group.</p>' +
				'</div>' +
				'</div>';
		}

		// Language constant templates for cluster descriptions
		var templateDescPattern = "<{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_TEMPLATE_DESC}>";
		var templateDescFallbackPattern = "<{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_TEMPLATE_DESC_FALLBACK}>";

		// Helper: build description text from a list of category names and metadata
		function buildClusterDescription(categoryNames, meta) {
			var catList = categoryNames.join(', ');
			if (meta.hasLinkedElements) {
				return templateDescPattern.replace('%s', catList).replace('%s', meta.formSingular);
			} else {
				return templateDescFallbackPattern.replace('%s', catList).replace('%s', meta.formPlural);
			}
		}

		// Helper: update the description text for a cluster based on current groups in it
		function updateClusterDescription($cluster) {
			// Collect category names from all template groups in this cluster
			var categoryNames = [];
			var firstMeta = null;
			$cluster.find('.template-group-in-cluster').each(function() {
				var gid = String($(this).data('groupid'));
				var meta = templateGroupMetadata[gid];
				if (meta) {
					categoryNames.push(meta.categoryName);
					if (!firstMeta) {
						firstMeta = meta;
					}
				}
			});
			if (categoryNames.length > 0 && firstMeta) {
				var desc = buildClusterDescription(categoryNames, firstMeta);
				var $descEl = $cluster.find('.template-group-cluster-description');
				if ($descEl.length) {
					$descEl.text(desc);
				} else {
					// Description element doesn't exist yet, create it before the checkboxes table
					var $cbs = $cluster.find('.template-group-cluster-checkboxes');
					var descHtml = '<div class="template-group-cluster-description" style="font-size: 0.85em; font-style: italic; color: #666; margin-top: 4px;">' + desc + '</div>';
					if ($cbs.length) {
						$cbs.before(descHtml);
					} else {
						$cluster.append(descHtml);
					}
				}
			}
		}

		// Helper: build a new cluster container with checkboxes grouped by form
		function buildClusterHtml(eagFormId, meta, firstGroupId, firstGroupName) {
			var html = '<div class="template-group-cluster" data-eagformid="' + eagFormId + '" style="margin-bottom: 5px; padding: 8px; background: #e9e9e9; border-radius: 3px;">';
			html += buildTemplateGroupItemHtml(firstGroupId, firstGroupName, eagFormId);
			var desc = buildClusterDescription([meta.categoryName], meta);
			html += '<div class="template-group-cluster-description" style="font-size: 0.85em; font-style: italic; color: #666; margin-top: 4px;">' + desc + '</div>';
			if (meta.elementsByForm && meta.elementsByForm.length > 0) {
				html += '<table class="template-group-cluster-checkboxes" style="margin-top: 4px; font-size: 0.9em; border: none; border-collapse: collapse;">';
				for (var f = 0; f < meta.elementsByForm.length; f++) {
					var fg = meta.elementsByForm[f];
					html += '<tr><td style="vertical-align: top; padding: 4px 12px 4px 0; width: 200px; text-align: right; border: none;">' + fg.formName + ':</td>';
					html += '<td style="vertical-align: top; padding: 4px 0; border: none;">';
					for (var i = 0; i < fg.elements.length; i++) {
						var le = fg.elements[i];
						html += '<label style="display: block;">' +
							'<input type="checkbox" name="entries_are_users_default_groups_element_links[' + eagFormId + '][]"' +
							' value="' + le.ele_id + '"' +
							' class="template-group-element-checkbox"' +
							' checked="checked" />' +
							' ' + le.caption +
							'</label>';
					}
					html += '</td></tr>';
				}
				html += '</table>';
			}
			html += '</div>';
			return html;
		}

		// Override the default groups autocomplete select behaviour
		// Instead of setting the textbox value, add the selected group to a list below
		$(window).load(function() {
			// Remove the original single-value hidden input so it doesn't conflict with the array inputs
			$("#entries_are_users_default_groups").remove();
			var $ac = $("#entries_are_users_default_groups_user");
			if ($ac.length && $ac.data("autocomplete")) {
				// Prevent hover from selecting/changing the textbox value
				$ac.autocomplete("option", "focus", function(event, ui) {
					event.preventDefault();
				});
				$ac.autocomplete("option", "select", function(event, ui) {
					event.preventDefault();
					if (ui.item.value == "none") {
						$ac.val("");
						return;
					}
					var groupId = ui.item.value;
					var groupName = ui.item.label;
					// Check if this group is already in the list
					if ($("#default_groups_selected_list .default-group-item[data-groupid='" + groupId + "']").length > 0) {
						$ac.val("");
						return;
					}
					var meta = templateGroupMetadata[groupId];
					if (meta) {
						// Template group — add to existing cluster or create new one
						var eagFormId = meta.eagFormId;
						var $existingCluster = $(".template-group-cluster[data-eagformid='" + eagFormId + "']");
						if ($existingCluster.length > 0) {
							// Add group item before the description/checkboxes section
							var $desc = $existingCluster.find(".template-group-cluster-description");
							var $cbs = $existingCluster.find(".template-group-cluster-checkboxes");
							var $insertBefore = $desc.length ? $desc : ($cbs.length ? $cbs : null);
							if ($insertBefore) {
								$insertBefore.before(buildTemplateGroupItemHtml(groupId, groupName, eagFormId));
							} else {
								$existingCluster.append(buildTemplateGroupItemHtml(groupId, groupName, eagFormId));
							}
							// Update the description to include the new category name
							updateClusterDescription($existingCluster);
						} else {
							// Create a new cluster
							$("#default_groups_selected_list").append(buildClusterHtml(eagFormId, meta, groupId, groupName));
						}
					} else {
						// Regular group — add as standalone item
						var itemHtml = '<div class="default-group-item" data-groupid="' + groupId + '" style="margin-bottom: 5px; padding: 4px 8px; background: #e9e9e9; border-radius: 3px;">' +
							'<span style="font-weight: bold;">' + groupName + '</span>' +
							' <span>&mdash;</span> ' +
							'<a href="#" class="toggle-group-conditions-btn" data-groupid="' + groupId + '" style="font-size: 0.85em; font-weight: normal;">' + conditionsShowLabel + '</a>' +
							' <span>&mdash;</span> ' +
							'<a href="#" class="remove-default-group-btn" style="font-size: 0.85em; font-weight: normal;">' + removeLabel + '</a>' +
							'<input type="hidden" name="entries_are_users_default_groups[]" value="' + groupId + '" />' +
							'<div class="per-group-conditions-panel" data-groupid="' + groupId + '" style="display: none; margin-top: 8px; padding: 10px; border: 1px solid #ccc; background: #f5f5f5; border-radius: 3px;">' +
							'<p style="font-size: 0.85em; color: #999;">No conditions set. Save the form to enable adding conditions for this group.</p>' +
							'</div>' +
							'</div>';
						$("#default_groups_selected_list").append(itemHtml);
					}
					$ac.val("");
				});
				// Also override the blur to just clear the box without setting the hidden value
				$ac.unbind("blur").blur(function() {
					$ac.val("");
				});
			}
		});

		// Remove default group from list — if it's the last group in a cluster, remove the whole cluster
		$(".remove-default-group-btn").live("click", function(e) {
			e.preventDefault();
			var $item = $(this).closest(".default-group-item");
			var $cluster = $item.closest(".template-group-cluster");
			$item.remove();
			if ($cluster.length > 0) {
				if ($cluster.find(".template-group-in-cluster").length == 0) {
					$cluster.remove();
				} else {
					// Update description to reflect remaining categories
					updateClusterDescription($cluster);
				}
			}
		});

		// Toggle per-group conditions panel visibility
		$(".toggle-group-conditions-btn").live("click", function(e) {
			e.preventDefault();
			var $link = $(this);
			var $panel = $link.closest(".default-group-item").find(".per-group-conditions-panel");
			if ($panel.is(':visible')) {
				$panel.slideUp();
				$link.text(conditionsShowLabel);
			} else {
				$panel.slideDown();
				$link.text(conditionsHideLabel);
			}
		});

		// Handle add condition button for per-group conditions (save+reload pattern)
		$(".per-group-conditions-panel input[name=addcon]").live("click", function() {
			$("#reload_settings").val(1);
			$(".savebutton").click();
			return false;
		});

		// Handle delete condition link for per-group conditions
		$(".per-group-conditions-panel a.conditionsdelete").live("click", function() {
			$("#per_group_conditionsdelete").val($(this).attr('target'));
			$("#reload_settings").val(1);
			$(".savebutton").click();
			return false;
		});
		</script>

			<div class="form-item">
				<fieldset>
					<legend><label class="question">Do you want to keep a revision history of all the changes people make to entries in this form?</label></legend>
					<div class="form-radios">
						<label for="store_revisions-0"><input type="radio" <{$content.revisionsDisabled}> id="store_revisions-0" name="forms-store_revisions" value="0" />No</label>
					</div>
					<div class="form-radios">
						<label for="store_revisions-1"><input type="radio" <{$content.revisionsDisabled}> id="store_revisions-1" name="forms-store_revisions" value="1" />Yes, store revision history for this form</label>
					</div>
					<div class="description">
						<p>This can increase the size of your database <b>a lot</b> if you turn on revisions for a form where entries are updated very often!</p><p>You can turn this on for all forms at once, through the <a href="../../system/admin.php?fct=preferences&op=showmod&mod=<{$adminPage.formulizeModId}>">Formulize preferences</a>. If you do that, then you cannot alter it here. This option becomes disabled.</p>
					</div>
				</fieldset>
			</div>

  		<div class="form-item">
				<fieldset>
					<legend><label class="question">Do you want to send notification e-mails for activity in this form once a day as a digest?</label></legend>
					<div class="form-radios">
						<label for="send_digests-0"><input type="radio" id="send_digests-0" name="forms-send_digests" value="0" />No, send notifications right away</label>
					</div>
					<div class="form-radios">
						<label for="send_digests-1"><input type="radio" id="send_digests-1" name="forms-send_digests" value="1" />Yes</label>
					</div>
					<div class="description">
						<p>This feature requires that you turn on the <a href="<{$xoops_url}>/modules/system/admin.php?fct=preferences&op=showmod&mod=<{$adminPage.formulizeModId}>">Formulize module Preference</a> for sending nofitications via cron job. In addition to creating a cron job for triggering 'notify.php' to process notification events, you will need to set a cron job for triggering 'digest.php' which will actually send the digest e-mails.</p>
					</div>
				</fieldset>
			</div>


	<{/if}>

	<{if $content.fid == "new"}>
	<div class="form-item">
	<fieldset>
		<legend><label class="question"><{$smarty.const._AM_SETTINGS_FORM_DEFAULT_GROUP_PERM}></label></legend>
		<select name="groups_can_edit[]" multiple size=8>
		<{html_options options=$content.groupsCanEditOptions selected=$content.groupsCanEditDefaults}>
		</select>
	</fieldset>
	</div>
<{else if $content.istableform == false}>
	<div class="form-item">
		<fieldset>
					<legend><label for="forms-form_title" class="question"><{$smarty.const._AM_EOG_Repair}>
					</label>
					</legend><input type="button" id="fix_entries" value="Repair Ownership table">
			 </fieldset>
	</div>
	<{if $content.fid != "new" AND $content.elementheadings|is_array AND $content.elementheadings|@count}>
	<div class="form-item">
		<fieldset>
							<legend><{$smarty.const._AM_SETTINGS_FORM_SHOWING_LIST_TITLE}></legend>
							<p><{$smarty.const._AM_SETTINGS_FORM_SHOWING_LIST}></p><br>
							<select name=headerlist[] size=10 multiple class="form-multiple-select">
									<{foreach from=$content.elementheadings item=element}>
									<option value=<{$element.ele_id}><{$element.selected}>><{$element.text}></option>
									<{/foreach}>
							</select>
					</fieldset>
	</div>
	<{/if}>
<{/if}>

<div class="form-item">
	<fieldset>
		<legend><label class="question">Notes</label></legend>
		<textarea id="forms-note" name="forms-note"><{$content.note}></textarea>
	</fieldset>
</div>

</form>
<!-- Thanks to https://github.com/plurals/pluralize/ !! -->
<script type="text/javascript" src="<{$xoops_url}>/modules/formulize/libraries/pluralize.js"></script>
<script type="text/javascript">
  $("#<{$content.singleentry}>").attr('checked', true);
  $("#store_revisions-<{$content.store_revisions}>").attr('checked', true);
  $("#send_digests-<{$content.send_digests}>").attr('checked', true);

	$("#forms-form_title").keydown(function () {
		window.document.getElementById('reload_settings').value = 1;
	});

	$('input:radio[name=new_app_yes_no]').change(function(){
		if($('input:radio[name=new_app_yes_no]:checked').val() == 'yes') {
			window.document.getElementById("new-application-box").style.display = 'block';
		} else {
			window.document.getElementById("new-application-box").style.display = 'none';
		}
		});

	function validateCustom() {
		if ($("[name=forms-form_handle]").val() == "") {
			fillHandle();
		}
		// Validate that each template group cluster has at least one element checkbox selected
		var templateGroupValid = true;
		$(".template-group-cluster").each(function() {
			var $checkboxes = $(this).find(".template-group-element-checkbox");
			if ($checkboxes.length > 0 && $checkboxes.filter(":checked").length == 0) {
				templateGroupValid = false;
				return false; // break out of each loop
			}
		});
		if (!templateGroupValid) {
			alert("<{$smarty.const._AM_SETTINGS_FORM_ENTRIES_ARE_USERS_DEFAULT_GROUPS_TEMPLATE_VALIDATION}>");
			return false;
		}
		return true;
	}
	function fillHandle(){
		var str=$("[name=forms-form_title]").val();
		if ("<{$content.fid}>" == "new") {
			handle=str.toLowerCase().replace(new RegExp("[^a-z0-9]","gm"),"_");
			handle=handle.replace(new RegExp("_{2,}","gm"),"_").substring(0,20);
			$("[name=forms-form_handle]").val(handle);
		}
		const suffixes = ["form", "data"];
		var formSuffix = suffixes.includes(str.substr(-4, 4).toLowerCase()) ? str.substr(-5, 5) : ''; // if/when suffixes aren't all four chars, this needs to change!
		if(formSuffix) {
			str = str.substr(0, str.length - 5);
		}
		if(pluralize.isSingular(str)) {
			var singular=str
			var plural=pluralize.plural(str)
		} else {
			var singular=pluralize.singular(str)
			var plural=str
		}
		$("[name=forms-singular]").val(singular);
		$("[name=forms-plural]").val(plural);
	}
	$('#fix_entries').click(function(){
		$.ajax({
			type:"POST",
			url:"<{$xoops_url}>/modules/formulize/admin/repair_eog_table.php",
			data:{"form_id":"<{$content.fid}>","form_handle":"<{$content.form_handle}>"},
			success:function(response){
				alert(response);
			}
		});
	});

	$("select[name=forms-pi]").change(function() {
		setPI($(this).val()); // function on elements tab
	});

	$('input[name=pi_new_caption]').keyup(function() {
		$('input[name=pi_new_yes_no][value=yes]').attr('checked', true);
	});
	$('input[name=pi_new_caption]').change(function() {
		$('input[name=pi_new_yes_no][value=yes]').attr('checked', true);
	});

	// Handle add condition button for entries_are_users_conditions (only for existing forms)
	$("div#entries_are_users_conditions_container input[name=addcon]").click(function () {
		$("#reload_settings").val(1);
		$(".savebutton").click();
		return false;
	});

	// Handle delete condition link for entries_are_users_conditions
	$("div#entries_are_users_conditions_container a.conditionsdelete").click(function () {
		$(".entries-are-users-conditions-conditionsdelete").val($(this).attr('target'));
		$("#reload_settings").val(1);
		$(".savebutton").click();
		return false;
	});

</script>
<div style="clear: both"></div>
</div> <!--// end content -->
