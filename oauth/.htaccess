# OAuth Endpoint Router
# Routes /oauth/authorize, /oauth/token, etc. to /oauth/index.php

RewriteEngine On

# Route all OAuth endpoint requests to index.php
# This allows /oauth/authorize to be handled by /oauth/index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [L,QSA]

# Ensure proper CORS headers for OAuth requests
<IfModule mod_headers.c>
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
    Header always set Access-Control-Max-Age "86400"
    Header always set Access-Control-Allow-Credentials "false"
</IfModule>

# Handle OPTIONS requests for CORS preflight
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^.*$ index.php [L]

# Security headers for OAuth endpoints
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Prevent direct access to sensitive files
<Files "*.json">
    Require all denied
</Files>

# Cache control for OAuth responses (prevent caching)
<IfModule mod_headers.c>
    Header always set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
    Header always set Pragma "no-cache"
    Header always set Expires "Thu, 01 Jan 1970 00:00:00 GMT"
</IfModule>