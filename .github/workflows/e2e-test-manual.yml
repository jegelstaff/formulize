name: Manual E2E Test Suite

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test against'
        required: true
        default: 'master'
        type: string
      skip_docker_build:
        description: 'Skip Docker rebuild (use existing containers)'
        required: false
        default: false
        type: boolean
      test_filter:
        description: 'Run specific tests (optional - use Playwright test filters)'
        required: false
        default: ''
        type: string

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  manual-e2e-test-run:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: tests/e2e/package-lock.json

    - name: Create .htaccess file in project root
      run: |
        cat > .htaccess << 'EOF'
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_FILENAME} !-l
        RewriteRule ^(.*)$ /modules/formulize/index.php?formulizeRewriteRuleAddress=$1 [L]
        EOF

    - name: Set file/directory permissions
      run: |
        chmod 777 trust uploads modules templates_c cache tokens logs modules/formulize/cache modules/formulize/code modules/formulize/export modules/formulize/language/english/mail_template modules/formulize/queue modules/formulize/temp modules/formulize/templates/screens modules/formulize/upload mainfile.php ~/work/formulize/formulize

    - name: Stop existing containers (if any)
      run: |
        docker compose down --remove-orphans || true

    - name: Run Docker Compose up
      run: |
        if [ "${{ inputs.skip_docker_build }}" == "false" ]; then
          echo "Building and starting containers..."
          docker compose up -d --build
        else
          echo "Starting existing containers..."
          docker compose up -d
        fi

    - name: Wait for MySQL
      uses: smurfpandey/wait-for-it@main
      with:
        host: localhost
        port: 3306
        timeout: 60

    - name: Install dependencies
      run: npm ci
      working-directory: tests/e2e

    - name: Install Playwright Browsers
      run: npx playwright install chromium --with-deps
      working-directory: tests/e2e

    - name: Run Playwright tests
      env:
        E2E_TEST_ADMIN_USERNAME: "admin"
        E2E_TEST_ADMIN_PASSWORD: "password"
      run: |
        if [ -n "${{ inputs.test_filter }}" ]; then
          echo "Running filtered tests: ${{ inputs.test_filter }}"
          npx playwright test ${{ inputs.test_filter }}
        else
          echo "Running all tests"
          npx playwright test
        fi
      working-directory: tests/e2e

    - name: Create database dump and collect files
      if: always()
      run: |
        # Create directory for the final state after tests
        mkdir -p tests/e2e/final-state/docker/mariadb/seed
        mkdir -p tests/e2e/final-state/trust
        mkdir -p tests/e2e/final-state/logs
        mkdir -p tests/e2e/final-state/modules/formulize/code
        mkdir -p tests/e2e/final-state/modules/formulize/templates/screens

        # Dump the database
        docker exec formulize-mariadb-1 mariadb-dump --user user --password=password --default-character-set=utf8mb4 --databases formulize > tests/e2e/final-state/docker/mariadb/seed/formulize.sql
        # Copy mainfile.php and install.lock
        cp mainfile.php tests/e2e/final-state/ || echo "mainfile.php not found"
        cp install.lock tests/e2e/final-state/ || echo "install.lock not found"

        # Copy trust folder contents
        if [ -d "trust" ]; then
          cp -r trust/* tests/e2e/final-state/trust/ || echo "trust folder empty or not accessible"
        fi

        # Copy logs folder contents
        if [ -d "logs" ]; then
          cp -r logs/* tests/e2e/final-state/logs/ || echo "logs folder empty or not accessible"
        fi

        # Copy code folder contents
        if [ -d "modules/formulize/code" ]; then
          cp -r modules/formulize/code/* tests/e2e/final-state/modules/formulize/code/ || echo "code folder empty or not accessible"
        fi

        # Copy templates/screens folder contents
        if [ -d "modules/formulize/templates/screens" ]; then
          cp -r modules/formulize/templates/screens/* tests/e2e/final-state/modules/formulize/templates/screens/ || echo "templates/screens folder empty or not accessible"
        fi

    - name: Clean up containers
      if: always()
      run: |
        docker compose down --remove-orphans

    - name: Upload Playwright Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: tests/e2e/test-report/
        retention-days: 7

    - name: Upload Final State
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: final-state
        path: tests/e2e/final-state/
        retention-days: 7
