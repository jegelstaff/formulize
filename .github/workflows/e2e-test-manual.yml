name: Manual E2E Test Suite

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test against'
        required: true
        default: 'master'
        type: string
      skip_docker_build:
        description: 'Skip Docker rebuild (use existing containers)'
        required: false
        default: false
        type: boolean
      test_filter:
        description: 'Run specific tests (optional - use Playwright test filters)'
        required: false
        default: ''
        type: string

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  manual-e2e-test-run:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: tests/e2e/package-lock.json

    - name: Create .htaccess file in project root
      run: |
        cat > .htaccess << 'EOF'
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_FILENAME} !-l
        RewriteRule ^(.*)$ /modules/formulize/index.php?formulizeRewriteRuleAddress=$1 [L]
        EOF

    - name: Set file/directory permissions
      run: |
        chmod 777 trust uploads modules templates_c cache tokens modules/formulize/cache modules/formulize/code modules/formulize/export modules/formulize/language/english/mail_template modules/formulize/queue modules/formulize/temp modules/formulize/templates/screens modules/formulize/upload mainfile.php ~/work/formulize/formulize

    - name: Stop existing containers (if any)
      run: |
        docker compose down --remove-orphans || true

    - name: Run Docker Compose up
      run: |
        if [ "${{ inputs.skip_docker_build }}" == "false" ]; then
          echo "Building and starting containers..."
          docker compose up -d --build
        else
          echo "Starting existing containers..."
          docker compose up -d
        fi

    - name: Wait for MySQL
      uses: smurfpandey/wait-for-it@main
      with:
        host: localhost
        port: 3306
        timeout: 60

    - name: Install dependencies
      run: npm ci
      working-directory: tests/e2e

    - name: Install Playwright Browsers
      run: npx playwright install chromium --with-deps
      working-directory: tests/e2e

    - name: Run Playwright tests
      env:
        E2E_TEST_ADMIN_USERNAME: "admin"
        E2E_TEST_ADMIN_PASSWORD: "password"
      run: |
        if [ -n "${{ inputs.test_filter }}" ]; then
          echo "Running filtered tests: ${{ inputs.test_filter }}"
          npx playwright test ${{ inputs.test_filter }}
        else
          echo "Running all tests"
          npx playwright test
        fi
      working-directory: tests/e2e

    - name: Clean up containers
      if: always()
      run: |
        docker compose down --remove-orphans

    - name: Upload Playwright Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: tests/e2e/test-report/
        retention-days: 30
