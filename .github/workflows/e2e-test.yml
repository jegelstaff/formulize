name: e2e test suite

on:
  push:
    branches:
      - master

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  check_commit:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Check commit message
      id: check
      run: |
        MESSAGE=$(git log --format=%B -n 1 ${{ github.event.after }})
        if [[ "$MESSAGE" == *"[SKIP TEST]"* || "$MESSAGE" == *"[SKIP TESTS]"* ]]; then
          echo "Commit message says to skip testing."
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi
  e2e-test-run:
    needs: check_commit
    if: needs.check_commit.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: tests/e2e/package-lock.json

    - name: Create .htaccess file in project root
      run: |
        cat > .htaccess << 'EOF'
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_FILENAME} !-l
        RewriteRule ^(.*)$ /modules/formulize/index.php?formulizeRewriteRuleAddress=$1 [L]
        EOF

    - name: Set file/directory permissions
      run: |
        chmod 777 trust uploads modules templates_c cache tokens logs modules/formulize/cache modules/formulize/code modules/formulize/export modules/formulize/language/english/mail_template modules/formulize/queue modules/formulize/temp modules/formulize/templates/screens modules/formulize/upload mainfile.php ~/work/formulize/formulize

    - name: Stop existing containers (if any)
      run: |
        docker compose down --remove-orphans || true

    - name: Run Docker Compose up
      run: |
        docker compose up -d

    - name: Wait for mysql
      uses: smurfpandey/wait-for-it@main
      with:
        host: localhost
        port: 3306
        timeout: 60

    - name: Install dependencies
      run: npm ci
      working-directory: tests/e2e

    - name: Install Playwright Browsers
      run: npx playwright install chromium --with-deps
      working-directory: tests/e2e

    - name: Run Playwright tests
      env:
        E2E_TEST_ADMIN_USERNAME: "admin"
        E2E_TEST_ADMIN_PASSWORD: "password"
      run: npx playwright test
      working-directory: tests/e2e

    - name: Create database dump and collect files
      if: always()
      run: |
        # Create directory for the final state after tests
        mkdir -p tests/e2e/final-state/docker/mariadb/seed
        mkdir -p tests/e2e/final-state/trust
        mkdir -p tests/e2e/final-state/logs

        # Dump the database
        docker exec formulize-mariadb-1 mariadb-dump --user user --password=password --default-character-set=utf8mb4 --databases formulize > tests/e2e/final-state/docker/mariadb/seed/formulize.sql
        # Copy mainfile.php and install.lock
        cp mainfile.php tests/e2e/final-state/ || echo "mainfile.php not found"
        cp install.lock tests/e2e/final-state/ || echo "install.lock not found"

        # Copy trust folder contents
        if [ -d "trust" ]; then
          cp -r trust/* tests/e2e/final-state/trust/ || echo "trust folder empty or not accessible"
        fi

        # Copy logs folder contents
        if [ -d "logs" ]; then
          cp -r logs/* tests/e2e/final-state/logs/ || echo "logs folder empty or not accessible"
        fi

        # Copy code folder contents
        if [ -d "modules/formulize/code" ]; then
          cp -r modules/formulize/code/* tests/e2e/final-state/modules/formulize/code/ || echo "code folder empty or not accessible"
        fi

    - name: Clean up containers
      if: always()
      run: |
        docker compose down --remove-orphans

    - name: Upload Playwright Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: tests/e2e/test-report/
        retention-days: 7

    - name: Upload Final State
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: final-state
        path: tests/e2e/final-state/
        retention-days: 7
