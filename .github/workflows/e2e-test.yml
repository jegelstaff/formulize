name: e2e test suite

on:
  push:
    branches:
      - master

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  check_commit:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Check commit message
      id: check
      run: |
        MESSAGE=$(git log --format=%B -n 1 ${{ github.event.after }})
        if [[ "$MESSAGE" == *"[SKIP TEST]"* ]]; then
          echo "Commit message contains [SKIP TEST]. We will skip running test."
          echo "::set-output name=skip::true"
        else
          echo "::set-output name=skip::false"
        fi
  e2e-test-run:
    needs: check_commit
    if: needs.check_commit.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: tests/e2e/package-lock.json

    - name: Set file/directory permissions
      run: |
        chmod 777 trust uploads modules templates_c cache tokens modules/formulize/cache modules/formulize/code modules/formulize/export modules/formulize/language/english/mail_template modules/formulize/queue modules/formulize/temp modules/formulize/templates/screens modules/formulize/upload mainfile.php ~/work/formulize/formulize

    - name: Stop existing containers (if any)
      run: |
        docker compose down --remove-orphans || true

    - name: Run Docker Compose up
      run: |
        docker compose up -d

    - name: Wait for mysql
      uses: smurfpandey/wait-for-it@main
      with:
        host: localhost
        port: 3306
        timeout: 60

    - name: Install dependencies
      run: npm ci
      working-directory: tests/e2e

    - name: Install Playwright Browsers
      run: npx playwright install chromium --with-deps
      working-directory: tests/e2e

    - name: Run Playwright tests
      env:
        E2E_TEST_ADMIN_USERNAME: "admin"
        E2E_TEST_ADMIN_PASSWORD: "password"
      run: npx playwright test
      working-directory: tests/e2e

    - name: Clean up containers
      if: always()
      run: |
        docker compose down --remove-orphans

    - name: Upload Playwright Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: tests/e2e/test-report/
        retention-days: 30
    # - name: Setup tmate session
    #   uses: mxschmitt/action-tmate@v3
